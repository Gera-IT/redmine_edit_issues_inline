<%= form_tag({}) do -%>
    <%= hidden_field_tag 'back_url', url_for(params), :id => nil %>
    <div class="autoscroll">
      <table class="list issues">
        <thead>
        <tr>
          <th class="checkbox hide-when-print">
            <%= link_to image_tag('toggle_check.png'), {},
                        :onclick => 'toggleIssuesSelection(this); return false;',
                        :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}" %>
          </th>
          <% query.inline_columns.each do |column| %>
              <%= column_header(column) %>
          <% end %>
        </tr>
        </thead>
        <% previous_group = false %>
        <tbody>
        <% issue_list(issues) do |issue, level| -%>
            <% if @query.grouped? && (group = @query.group_by_column.value(issue)) != previous_group %>
                <% reset_cycle %>
                <tr class="group open">
                  <td colspan="<%= query.inline_columns.size + 2 %>">
                    <span class="expander" onclick="toggleRowGroup(this);">&nbsp;</span>
                    <%= group.blank? ? l(:label_none) : column_content(@query.group_by_column, issue) %> <span class="count"><%= @issue_count_by_group[group] %></span>
                    <%= link_to_function("#{l(:button_collapse_all)}/#{l(:button_expand_all)}",
                                         "toggleAllRowGroups(this)", :class => 'toggle-all') %>
                  </td>
                </tr>
                <% previous_group = group %>
            <% end %>
            <tr id="issue-<%= issue.id %>" class="hascontextmenu <%= cycle('odd', 'even') %> <%= issue.css_classes %> <%= level > 0 ? "idnt idnt-#{level}" : nil %>">
              <td class="checkbox hide-when-print"><%= check_box_tag("ids[]", issue.id, false, :id => nil) %></td>
              <% p query.inline_columns.map(&:name) %>
              <% query.inline_columns.each do |column| %>
                <td class="<%= column.css_classes%>">
                  <% p column %>
                  <% proj = issue.project  %>
                  <% if InlineHelper.define_type(column) == :uneditable_field %>
                      <%= column_content(column, issue) %>
                    <%#= raw "<td class=\"#{column.css_classes}\">#{column_content(column, issue)}</td>" %>
                  <% elsif InlineHelper.define_type(column) == :select %>
                    <%= best_in_place issue, column.name, :type => :select, :collection => InlineHelper.get_collection(column.name, proj.id),
                                      :path => issues_inline_update_inline_path(:issues_inline_id => issue.id, :project_id => proj.id, :need_object_value => true), :simple_value => issue.send(column.name).try(:name)
                    %>
                  <% elsif InlineHelper.define_type(column) == :bool %>
                    <%= best_in_place issue, column.name, :type => :checkbox, :collection => ["No", "Yes"],
                                        :path => issues_inline_update_inline_path(:issues_inline_id => issue.id, :project_id => proj.id), :simple_value => issue.send(column.name) ? "Yes" : "No", :need_object_value => false%>
                  <% elsif InlineHelper.define_type(column) == :custom_field %>
                    <% if InlineHelper.find_custom_value_object(issue, column) %>
                      <%= best_in_place (InlineHelper.find_custom_value_object(issue, column)), :value, InlineHelper.generate_bip_params(issue, column) %>
                    <% else %>
                      <p>No inline edit available</p>
                    <% end %>
                           <%#= raw "<td class=\"#{column.css_classes}\">#{column_content(column, issue)}</td>" %>
                  <% elsif [:due_date, :start_date].include?(column.name) %>
                        <%# if [:due_date, :start_date].include?(column.name) %>
                      <%= best_in_place issue, column.name.to_sym, :type => :input,
                                                 :path => issues_inline_update_inline_path(:issues_inline_id => issue.id, :project_id => @project.id), :inner_class => '', :ok_button => 'Save', :activator => "#issue_#{issue.id}_#{column.name.to_s}" %>
                      <%= image_tag 'calendar.png', :plugin => 'task_inline_edit', :class => 'ui-datepicker-trigger', :id => "issue_#{issue.id}_#{column.name.to_s}" %>
                  <% elsif InlineHelper.define_type(column) == :input %>
                      <%= best_in_place issue, column.name.to_sym, :type => :input, :path => issues_inline_update_inline_path(:issues_inline_id => issue.id, :project_id => @project.id), :ok_button => 'Save' %>
                  <% end %>
                </td>
              <% end %>
            </tr>
            <% @query.block_columns.each do |column|
              if (text = column_content(column, issue)) && text.present? -%>
                    <tr class="<%= current_cycle %>">
                      <td colspan="<%= @query.inline_columns.size + 1 %>" class="<%= column.css_classes %>"><%= text %></td>
                    </tr>
                <% end -%>
            <% end -%>
        <% end -%>
        </tbody>
      </table>
    </div>
<% end -%>
